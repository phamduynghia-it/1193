<!doctype html>
<html>
    <meta charset="utf-8" />

    <head>
        <title>HAPPY NEW YEAR</title>
    </head>

    <body>
        <audio id="bgMusic" src="music.mp3" preload="auto" loop></audio>

        <!-- FIREWORK BACKGROUND -->
        <canvas id="canvas"></canvas>

        <!-- TEXT PARTICLES -->
        <canvas id="countdownCanvas"></canvas>

        <!-- HEART EFFECT -->
        <canvas id="pinkboard"></canvas>

        <div
            id="tapHint"
            style="
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translateX(-50%);
                color: #aaa;
                font-size: 18px;
                z-index: 20;
            "
        >
            Nh·∫•n v√†o m√†n h√¨nh ƒë·ªÉ b·∫Øt ƒë·∫ßu
        </div>

        <div id="child" style="display: none"></div>

        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: black;
            }

            canvas {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #canvas {
                z-index: 1;
            }

            #countdownCanvas {
                z-index: 10;
            }

            #pinkboard {
                z-index: 5;
            }

            #child {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 15;
            }

            h4 {
                font-family: Mali, Arial;
                font-size: 40px;
                color: #fff;
                margin: 0;
            }
        </style>

        <!-- ================= FIREWORK BACKGROUND ================= -->
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            const FIRE_COLORS = [
                "#ff4d4d", // ƒë·ªè
                "#ff6b6b",
                "#ff69b4", // h·ªìng
                "#ff85c1",
                "#ffd700", // v√†ng
                "#ffe066",
                "#7bed9f", // xanh l√°
                "#2ed573",
                "#00e5ff", // xanh d∆∞∆°ng
                "#1e90ff",
                "#70a1ff",
                "#b388ff", // t√≠m
                "#a29bfe",
                "#d980fa",
                "#f368e0",
            ];

            const isMobile = innerWidth < 768;
            const fireworks = [];
            const particles = [];
            const MAX_PARTICLES = isMobile ? 120 : 280;
            const stars = [];
            const STAR_COUNT = isMobile ? 60 : 120;

            for (let i = 0; i < STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 1.2 + 0.3,
                    a: Math.random(),
                    da: Math.random() * 0.02 + 0.005,
                });
            }

            function drawStars() {
                stars.forEach((s) => {
                    s.a += s.da;
                    if (s.a >= 1 || s.a <= 0) s.da *= -1;

                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${s.a})`;
                    ctx.fill();
                });
            }
            class Firework {
                constructor(type) {
                    this.type = type;
                    this.color =
                        FIRE_COLORS[
                            Math.floor(Math.random() * FIRE_COLORS.length)
                        ];
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height;
                    this.ty = Math.random() * canvas.height * 0.5;
                    this.vy = -(isMobile ? 6 : 8);
                }

                update() {
                    this.y += this.vy;
                    if (this.y <= this.ty) {
                        explode(this.x, this.y, this.type, this.color);

                        return false;
                    }
                    return true;
                }
                draw() {
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(this.x, this.y, 2, 2);
                }
            }

            function explode(x, y, type, color) {
                let count = isMobile ? 20 : 30;
                let angleStep = (Math.PI * 2) / count;

                for (let i = 0; i < count; i++) {
                    let angle = angleStep * i;
                    let speed = Math.random() * 3 + 2;

                    let vx = Math.cos(angle) * speed;
                    let vy = Math.sin(angle) * speed;

                    if (type === "rain") vy = Math.random() * 3 + 2;
                    if (type === "star") speed *= 1.4;

                    particles.push({
                        x,
                        y,
                        vx,
                        vy,
                        life: isMobile ? 40 : 60,
                        color,
                    });
                }
            }

            function launchSalvo() {
                let shots = Math.floor(Math.random() * 3) + 2; // 2‚Äì4 qu·∫£
                const types = ["classic", "star", "rain"];

                for (let i = 0; i < shots; i++) {
                    fireworks.push(
                        new Firework(
                            types[Math.floor(Math.random() * types.length)],
                        ),
                    );
                }
            }

            function animate() {
                ctx.fillStyle = "rgba(0,0,0,0.2)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawStars();
                if (Math.random() < 0.04) launchSalvo();

                fireworks.forEach((f, i) => {
                    if (!f.update()) fireworks.splice(i, 1);
                    else f.draw();
                });

                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 2, 2);

                    if (p.life <= 0 || particles.length > MAX_PARTICLES)
                        particles.splice(i, 1);
                });

                requestAnimationFrame(animate);
            }
            animate();
        </script>

        <script>
            /* ================= COUNTDOWN PARTICLES ================= */
            var countdownParticles = [];
            var countdownTexts = [
                "‚ù§",
                "Happy new year,\n Andy",
                "NƒÉm m·ªõi mong\n anh lu√¥n c∆∞·ªùi\n th·∫≠t t∆∞∆°i",
                "M·ªói ng√†y tr√¥i\n qua ƒë·ªÅu nh·∫π nh√†ng\n v·ªõi anh",
                "Bu·ªìn vui g√¨\n c≈©ng c√≥ em\n b√™n c·∫°nh",
                "v·∫°n s·ª± nh∆∞ √Ω",
                "tri·ªáu s·ª± nh∆∞ m∆°",
                "trƒÉm s·ª± b·∫•t ng·ªù",
                "h√†ng gi·ªù h·∫°nh ph√∫c",
                "em y√™u Andy\n r·∫•t nh√¨u",
                "Ho√†ng Nga",
            ];

            var currentTextIndex = 0;
            var countdownStage = "idle"; // idle | forming | holding | dispersing
            var stableTime = 0; // bi·∫øn ƒë·∫øm th·ªùi gian

            // --- C·∫§U H√åNH TH·ªúI GIAN ·ªû ƒê√ÇY ---
            var STABLE_DURATION = 150; // TƒÉng l√™n 500 ƒë·ªÉ ch·ªØ gi·ªØ n√©t l√¢u h∆°n (t·∫ßm 8-9 gi√¢y)
            var FORMING_SPEED = 0.1; // TƒÉng t·ªëc ƒë·ªô bay t·ª´ 0.1 l√™n 0.35 ƒë·ªÉ gi·∫£m th·ªùi gian b·ªã v·ª°
            // -------------------------------

            var countdownHoldTime = 0;
            var countdownCtx = document
                .getElementById("countdownCanvas")
                .getContext("2d");

            var started = false;
            var pinkboardStarted = false;
            var particleSize = 3;
            var particleDensity = 6; // Gi·∫£m nh·∫π m·∫≠t ƒë·ªô ƒë·ªÉ ƒë·ª° lag n·∫øu m√°y y·∫øu

            function initCountdownCanvas() {
                var canvas = document.getElementById("countdownCanvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            function createTextParticles(text) {
                countdownParticles = [];
                text = text.replace(/\s+\n/g, "\n");
                var lines = text.split("\n").map((s) => s.trim());

                var tempCanvas = document.createElement("canvas");
                var tempCtx = tempCanvas.getContext("2d");

                var maxAllowedWidth = window.innerWidth * 0.8;
                var fontSize = Math.min(window.innerWidth / 8, 220);
                tempCtx.font = `bold ${fontSize}px Arial`;

                function measure() {
                    return Math.max(
                        ...lines.map((l) => tempCtx.measureText(l).width),
                    );
                }
                while (measure() > maxAllowedWidth && fontSize > 18) {
                    fontSize *= 0.9;
                    tempCtx.font = `bold ${fontSize}px Arial`;
                }

                var lineHeight = fontSize * 1.2;
                tempCanvas.width = window.innerWidth;
                tempCanvas.height = lineHeight * lines.length + fontSize;

                tempCtx.font = `bold ${fontSize}px Arial`;
                tempCtx.fillStyle = "#ff69b4";

                tempCtx.textAlign = "center";
                tempCtx.textBaseline = "middle";
                tempCtx.shadowColor = "#800080";
                tempCtx.shadowBlur = 8;

                var startY =
                    tempCanvas.height / 2 -
                    ((lines.length - 1) * lineHeight) / 2;
                lines.forEach((l, i) => {
                    tempCtx.fillText(
                        l,
                        tempCanvas.width / 2,
                        startY + i * lineHeight,
                    );
                });

                var data = tempCtx.getImageData(
                    0,
                    0,
                    tempCanvas.width,
                    tempCanvas.height,
                ).data;
                for (var y = 0; y < tempCanvas.height; y += particleDensity) {
                    for (
                        var x = 0;
                        x < tempCanvas.width;
                        x += particleDensity
                    ) {
                        if (data[(y * tempCanvas.width + x) * 4 + 3] > 128) {
                            countdownParticles.push({
                                x: Math.random() * window.innerWidth, // V·ªã tr√≠ ban ƒë·∫ßu ng·∫´u nhi√™n
                                y: Math.random() * window.innerHeight,
                                targetX:
                                    x -
                                    tempCanvas.width / 2 +
                                    window.innerWidth / 2,
                                targetY:
                                    y -
                                    tempCanvas.height / 2 +
                                    window.innerHeight / 2,
                                vx: 0,
                                vy: 0,
                                size: particleSize,
                            });
                        }
                    }
                }
            }

            function updateCountdownParticles() {
                if (!started) return;

                countdownCtx.clearRect(
                    0,
                    0,
                    window.innerWidth,
                    window.innerHeight,
                );
                var done = true;

                countdownParticles.forEach((p) => {
                    if (countdownStage === "forming") {
                        // TƒÉng t·ªëc ƒë·ªô bay v·ªÅ ƒë√≠ch ƒë·ªÉ gi·∫£m th·ªùi gian "v·ª°"
                        p.vx = (p.targetX - p.x) * FORMING_SPEED;
                        p.vy = (p.targetY - p.y) * FORMING_SPEED;

                        // C·∫≠p nh·∫≠t v·ªã tr√≠
                        p.x += p.vx;
                        p.y += p.vy;

                        // Ki·ªÉm tra xem ƒë√£ ƒë·∫øn n∆°i ch∆∞a (sai s·ªë nh·ªè h∆°n 1px)
                        if (
                            Math.abs(p.targetX - p.x) > 1 ||
                            Math.abs(p.targetY - p.y) > 1
                        ) {
                            done = false;
                        } else {
                            // N·∫øu ƒë√£ r·∫•t g·∫ßn, g√°n c·ª©ng v·ªã tr√≠ ƒë·ªÉ ch·ªØ s·∫Øc n√©t
                            p.x = p.targetX;
                            p.y = p.targetY;
                        }
                    } else if (countdownStage === "stable") {
                        // Khi ƒë√£ ·ªïn ƒë·ªãnh, kh√≥a c·ª©ng v·ªã tr√≠ tuy·ªát ƒë·ªëi, kh√¥ng rung l·∫Øc
                        p.x = p.targetX;
                        p.y = p.targetY;
                    }
                    // Giai ƒëo·∫°n dispersing (tan r√£) n·∫øu mu·ªën th√™m hi·ªáu ·ª©ng n·ªï th√¨ code ·ªü ƒë√¢y
                    // Hi·ªán t·∫°i code c≈© ch·ªâ chuy·ªÉn text lu√¥n n√™n ko c·∫ßn x·ª≠ l√Ω

                    countdownCtx.beginPath();
                    countdownCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    //thay m√†u m·∫£ng ch·ªØ
                    countdownCtx.fillStyle = "#FF0000";
                    countdownCtx.fill();
                });

                if (countdownStage === "forming" && done) {
                    countdownStage = "stable"; // Chuy·ªÉn sang ch·∫ø ƒë·ªô gi·ªØ n√©t
                    stableTime = 0;
                }

                if (countdownStage === "stable") {
                    // üö´ N·∫æU L√Ä C√ÇU CU·ªêI ‚Üí GI·ªÆ M√ÉI, KH√îNG TAN
                    if (currentTextIndex === countdownTexts.length - 1) {
                        // kh√≥a vƒ©nh vi·ªÖn ·ªü tr·∫°ng th√°i stable
                        return requestAnimationFrame(updateCountdownParticles);
                    }

                    stableTime++;
                    if (stableTime > STABLE_DURATION) {
                        countdownStage = "dispersing";
                    }
                }

                if (countdownStage === "dispersing") {
                    currentTextIndex++;
                    if (currentTextIndex < countdownTexts.length) {
                        createTextParticles(countdownTexts[currentTextIndex]);
                        countdownStage = "forming";
                    } else {
                        document.getElementById(
                            "countdownCanvas",
                        ).style.display = "none";
                        document.getElementById("child").style.display =
                            "block";
                        if (!pinkboardStarted) initPinkboard();
                        return;
                    }
                }
                requestAnimationFrame(updateCountdownParticles);
            }
        </script>
        <!-- ================= COUNTDOWN TEXT (GI·ªÆ NGUY√äN) ================= -->
        <!-- (Gi·ªØ nguy√™n to√†n b·ªô code ch·ªØ b·∫°n g·ª≠i ‚Äì KH√îNG S·ª¨A) -->
        <!-- üëâ V√¨ qu√° d√†i n√™n m√¨nh KH√îNG l·∫∑p l·∫°i ·ªü ƒë√¢y -->
        <!-- üëâ B·∫°n gi·ªØ nguy√™n to√†n b·ªô script countdownParticles c≈© -->

        <!-- ================= CLICK START ================= -->

        <script>
            function startLove(e) {
                if (started) return;
                started = true;

                document.getElementById("tapHint").style.display = "none";

                const audio = document.getElementById("bgMusic");
                audio.volume = 0.8;
                audio.currentTime = 0;

                // üîì UNLOCK + PLAY TRONG C√ôNG GESTURE
                audio
                    .play()
                    .then(() => {
                        // OK cho Android + iOS
                    })
                    .catch(() => {
                        console.log("Audio b·ªã ch·∫∑n");
                    });

                // START TEXT
                initCountdownCanvas();
                createTextParticles(countdownTexts[0]);
                countdownStage = "forming";
                updateCountdownParticles();
            }

            document.addEventListener("touchstart", startLove, { once: true });
            document.addEventListener("click", startLove, { once: true });
        </script>
    </body>
</html>
